<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tempo Testnet Click Game</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1020; color:#eaf0ff; margin:0; }
    .wrap { max-width: 780px; margin: 40px auto; padding: 20px; }
    .card { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:16px; padding:18px; margin-bottom:14px; }
    button { cursor:pointer; border:0; border-radius:12px; padding:10px 14px; font-weight:700; }
    .btn { background:#ff4d6d; color:#0b1020; }
    .btn2 { background:#2ee59d; color:#07121a; }
    .muted { color: rgba(234,240,255,0.75); }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    #target { width: 160px; height:160px; border-radius: 999px; display:grid; place-items:center; margin: 16px auto;
      background: radial-gradient(circle at 30% 30%, #ffd166, #ff4d6d);
      box-shadow: 0 18px 50px rgba(255,77,109,0.35);
      user-select:none; font-size:40px; }
    #target:active { transform: scale(0.96); }
    .big { font-size: 42px; font-weight: 900; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px;">Tempo Testnet Click Game</h2>
      <div class="muted">
        Oynamak iÃ§in MetaMask (Chrome eklentisi) baÄŸlamak zorunlu. AÄŸ otomatik Tempo Testnet (Andantino)â€™ye alÄ±nÄ±r.
      </div>
    </div>

    <div class="card" id="connectCard">
      <div class="row">
        <button class="btn" id="btnConnect">ğŸ¦Š MetaMask ile BaÄŸlan</button>
        <button class="btn2" id="btnSwitch">ğŸ” Tempo Testnetâ€™e GeÃ§</button>
      </div>
      <div style="margin-top:10px;">
        Durum: <span id="status" class="muted">BaÄŸlÄ± deÄŸil</span>
      </div>
      <div style="margin-top:6px;">
        CÃ¼zdan: <span id="addr" class="mono muted">-</span>
      </div>
      <div style="margin-top:6px;">
        AÄŸ: <span id="chain" class="mono muted">-</span>
      </div>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.12);margin:14px 0;" />

      <div class="muted" style="font-size:14px;">
        Tempo testnet aÄŸ bilgileri (dokÃ¼mana gÃ¶re): Chain ID <span class="mono">42429</span>, RPC <span class="mono">https://rpc.testnet.tempo.xyz</span>, Explorer <span class="mono">https://explore.tempo.xyz</span>, sembol <span class="mono">USD</span>. ([docs.tempo.xyz](https://docs.tempo.xyz/quickstart/connection-details?utm_source=openai))
      </div>
      <div class="muted" style="font-size:14px; margin-top:8px;">
        Test fon (stablecoin) almak iÃ§in dokÃ¼manda RPC yÃ¶ntemi: <span class="mono">tempo_fundAddress</span>. ([docs.tempo.xyz](https://docs.tempo.xyz/guide/use-accounts/add-funds?utm_source=openai))
      </div>
    </div>

    <div class="card" id="gameCard" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div>â±ï¸ SÃ¼re: <span id="time" class="mono">30</span>s</div>
        <div>Skor: <span id="score" class="big">0</span></div>
      </div>

      <div id="target">ğŸ‘†</div>

      <div class="row" style="justify-content:center;">
        <button class="btn2" id="btnStart">ğŸš€ BaÅŸlat</button>
      </div>

      <div style="margin-top:12px;">
        Zincirdeki best score: <span id="bestOnchain" class="mono muted">-</span>
      </div>
      <div style="margin-top:6px;">
        Son tx: <span id="lastTx" class="mono muted">-</span>
      </div>

      <div class="muted" style="font-size:13px;margin-top:10px;">
        Oyun bitince skor, Tempo Testnet Ã¼zerinde Scoreboard kontratÄ±na yazÄ±lÄ±r (TX onayÄ± MetaMaskâ€™te Ã§Ä±kar).
      </div>
    </div>
  </div>

  <!-- ethers v6 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.5/dist/ethers.umd.min.js"></script>
  <script>
    // === Tempo Testnet (Andantino) parametreleri (dokÃ¼mandan) ===
    const TEMPO = {
      chainIdDec: 42429,
      chainIdHex: "0xA5BD", // 42429
      chainName: "Tempo Testnet (Andantino)",
      rpcUrls: ["https://rpc.testnet.tempo.xyz"],
      blockExplorerUrls: ["https://explore.tempo.xyz"],
      nativeCurrency: {
        name: "USD",
        symbol: "USD",
        // DokÃ¼manda bazÄ± cÃ¼zdanlarda 18 gerekebileceÄŸi notu var
        decimals: 18
      }
    };

    // === 1) Buraya deploy ettiÄŸin kontrat adresini koy ===
    const SCOREBOARD_ADDRESS = "0x0000000000000000000000000000000000000000";

    // Minimal ABI
    const SCOREBOARD_ABI = [
      "function bestScore(address) view returns (uint256)",
      "function submitScore(uint256 score)",
      "event ScoreSubmitted(address indexed player, uint256 score, uint256 newBest)"
    ];

    let provider, signer, account, contract;
    let running = false, timeLeft = 30, timer = null, score = 0;

    const el = (id) => document.getElementById(id);

    function isMetaMaskReady() {
      return !!(window.ethereum && window.ethereum.isMetaMask);
    }

    async function ensureTempoNetwork() {
      const chainId = await window.ethereum.request({ method: "eth_chainId" });
      el("chain").textContent = chainId;

      if (chainId === TEMPO.chainIdHex) return;

      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: TEMPO.chainIdHex }]
        });
      } catch (e) {
        // 4902: network not added
        if (e && e.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [TEMPO]
          });
        } else {
          throw e;
        }
      }

      const newChainId = await window.ethereum.request({ method: "eth_chainId" });
      el("chain").textContent = newChainId;
    }

    function shortAddr(a) {
      return a ? (a.slice(0, 6) + "..." + a.slice(-4)) : "-";
    }

    async function connect() {
      if (!isMetaMaskReady()) {
        el("status").textContent = "MetaMask bulunamadÄ±. Chrome eklentisini kurmalÄ±sÄ±n.";
        return;
      }

      el("status").textContent = "BaÄŸlanÄ±lÄ±yor...";
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      account = accounts[0];
      el("addr").textContent = shortAddr(account);

      await ensureTempoNetwork();

      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();

      // Kontrat adresi ayarlÄ±ysa kontrata baÄŸlan
      if (SCOREBOARD_ADDRESS && SCOREBOARD_ADDRESS !== "0x0000000000000000000000000000000000000000") {
        contract = new ethers.Contract(SCOREBOARD_ADDRESS, SCOREBOARD_ABI, signer);
        await refreshBestOnchain();
      } else {
        el("bestOnchain").textContent = "(Kontrat adresi girilmedi)";
      }

      el("status").textContent = "BaÄŸlandÄ± âœ…";
      el("connectCard").style.display = "none";
      el("gameCard").style.display = "block";
    }

    async function refreshBestOnchain() {
      if (!contract || !account) return;
      const best = await contract.bestScore(account);
      el("bestOnchain").textContent = best.toString();
    }

    function resetGameUI() {
      score = 0;
      timeLeft = 30;
      el("score").textContent = "0";
      el("time").textContent = "30";
    }

    function stopTimer() {
      if (timer) clearInterval(timer);
      timer = null;
    }

    async function endGame() {
      running = false;
      stopTimer();

      // Skoru zincire yaz
      if (!contract) {
        el("lastTx").textContent = "Kontrat yok (SCOREBOARD_ADDRESS ayarla)";
        return;
      }

      try {
        el("lastTx").textContent = "TX gÃ¶nderiliyor (MetaMask onayÄ± bekler)...";
        const tx = await contract.submitScore(score);
        el("lastTx").textContent = tx.hash;

        await tx.wait();
        await refreshBestOnchain();
      } catch (e) {
        el("lastTx").textContent = "TX baÅŸarÄ±sÄ±z / reddedildi: " + (e?.message || e);
      }
    }

    function startGame() {
      if (!account) return;
      if (running) return;

      resetGameUI();
      running = true;

      timer = setInterval(async () => {
        timeLeft -= 1;
        el("time").textContent = String(timeLeft);

        if (timeLeft <= 0) {
          await endGame();
        }
      }, 1000);
    }

    function clickTarget() {
      if (!running) return;
      score += 1;
      el("score").textContent = String(score);
    }

    // UI hooks
    el("btnConnect").onclick = connect;
    el("btnSwitch").onclick = async () => {
      try { await ensureTempoNetwork(); el("status").textContent = "Tempo Testnet aktif âœ…"; }
      catch (e) { el("status").textContent = "AÄŸ deÄŸiÅŸimi baÅŸarÄ±sÄ±z: " + (e?.message || e); }
    };
    el("btnStart").onclick = startGame;
    el("target").onclick = clickTarget;

    // MetaMask events
    if (window.ethereum) {
      window.ethereum.on("accountsChanged", (accs) => {
        account = accs?.[0] || null;
        el("addr").textContent = shortAddr(account);
      });
      window.ethereum.on("chainChanged", (cid) => {
        el("chain").textContent = cid;
      });
    }
  </script>
</body>
</html>
